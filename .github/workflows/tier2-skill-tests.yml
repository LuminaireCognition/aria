name: Tier 2 Skill Integration Tests

on:
  schedule:
    - cron: '0 6 * * 1'  # Monday 06:00 UTC
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Pytest filter (e.g., "build_cost or route")'
        type: string
        default: ''

concurrency:
  group: tier2-skill-tests
  cancel-in-progress: false

jobs:
  tier1-sanity:
    name: Tier 1 Sanity Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - run: uv python install 3.12
      - run: uv sync --all-extras
      - name: Run Tier 1 tests
        run: |
          uv run pytest tests/skills/test_integration.py \
            -m tier1 -v --tb=short --no-cov

  tier2-integration:
    name: Tier 2 API Integration
    runs-on: ubuntu-latest
    needs: [tier1-sanity]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - run: uv python install 3.12
      - run: uv sync --all-extras

      - name: Run Tier 2 tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          FILTER="${{ github.event.inputs.test_filter }}"
          ARGS=("-m" "tier2" "-v" "--tb=long" "--no-cov")
          [ -n "$FILTER" ] && ARGS+=("-k" "$FILTER")
          uv run pytest tests/skills/test_integration.py "${ARGS[@]}"

      - name: Generate summary
        if: always()
        run: |
          echo "## Tier 2 Results" >> $GITHUB_STEP_SUMMARY
          echo "Run: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Time: $(date -u)" >> $GITHUB_STEP_SUMMARY
